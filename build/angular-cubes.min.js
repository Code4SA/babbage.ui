/*! angular-cubes 2015-06-23 */
function asArray(a){return objs=a?a:[],angular.isArray(objs)?objs:[objs]}var makeSignal=function(a){return"cubes_"+Math.random().toString(36).replace(/[^a-z]+/g,"")};String.prototype.endsWith||(String.prototype.endsWith=function(a,b){var c=this.toString();(void 0===b||b>c.length)&&(b=c.length),b-=a.length;var d=c.indexOf(a,b);return-1!==d&&d===b});var ngCubes=angular.module("ngCubes",["ngCubes.templates"]),numberFormat=d3.format("0,000");ngCubes.filter("numeric",function(){return function(a){var b=parseFloat(a);return isNaN(b)?"-":numberFormat(Math.round(b))}}),ngCubes.factory("cubesApi",["$http","$q",function(a,b){var c={},d=function(a,b,c){var d=a.slice(),d=d.endsWith("/")?d.slice(0,d.length-1):d,d=d+"/cube/"+b+"/"+c;return d},e=function(b){return angular.isDefined(c[b])||(c[b]=a.get(b)),c[b]},f=function(a,b){return e(d(a,b,"model"))},g=function(a,b,c){return e(d(a,b,"members/"+c))},h=function(){c={}};return{getUrl:d,getModel:f,getDimensionMembers:g,flush:h}}]),ngCubes.directive("cubes",["$http","$rootScope","$location","cubesApi",function(a,b,c,d){return{restrict:"E",transclude:!0,scope:{slicer:"@",cube:"@",state:"="},templateUrl:"angular-cubes-templates/cubes.html",controller:["$scope",function(a){var e=this,f=angular.extend({},a.state||{},c.search());e.dataUpdate=makeSignal(),e.modelUpdate=makeSignal(),e.queryModel={},e.init=function(c){e.queryModel=c,d.getModel(a.slicer,a.cube).then(function(a){b.$broadcast(e.modelUpdate,a.data,f)})},e.getState=function(){return f},e.setState=function(a){c.search(a)},e.getApiUrl=function(b){return d.getUrl(a.slicer,a.cube,b)},e.getDimensionMembers=function(b){return getDimensionMembers(a.slicer,a.cube,b)},e.getQuery=function(){var a={drilldown:[],aggregates:[],cut:f.cut||[],page:f.page||0,pagesize:f.pagesize||20,order:[]};return a},e.queryParams=function(a){for(var b in a)angular.isArray(a[b])&&(-1==["order","fields"].indexOf(b)?a[b]=a[b].join("|"):a[b]=a[b].join(",")),a[b]=a[b]+"",a[b].length||delete a[b];return{params:a}}}]}}]),ngCubes.directive("cubesPager",["$timeout","$location",function(a,b){return{restrict:"E",scope:{context:"="},templateUrl:"angular-cubes-templates/pager.html",link:function(a,c,d,e){a.showPager=!1,a.hasPrev=!1,a.hasNext=!1,a.pages=[],a.cur=0,a.num=0,a.$watch("context",function(b){if(a.context&&!(a.context.total<=a.context.pagesize)){a.current=parseInt(a.context.page,10)||0,a.num=Math.ceil(a.context.total/a.context.pagesize);var c=[],d=a.num,e=3,f=a.current-e,g=a.current+e;0>f&&(f=0,g=Math.min(2*e+1,d)),g>d&&(g=d,f=Math.max(1,d-2*e+1));for(var h=f;g>=h;h++)c.push({page:h,current:h==a.current});a.hasPrev=a.current>0,a.hasNext=a.current<d,a.showPager=d>1,a.pages=c}}),a.setPage=function(c){if(c>=0&&c<=a.num){var d=b.search();d.page=c,b.search(d)}}}}}]);var VAL_KEY="@@@@",POS_KEY="!@!@";ngCubes.directive("cubesCrosstab",["$rootScope","$http",function(a,b){return{restrict:"EA",require:"^cubes",scope:{drilldown:"="},templateUrl:"angular-cubes-templates/crosstab.html",link:function(c,d,e,f){c.columns=[],c.rows=[],c.table=[];var g=function(a,c){c.rows=asArray(c.rows),c.columns=asArray(c.columns),c.aggregates=asArray(c.aggregates);var d=f.getQuery();d.aggregates=d.aggregates.concat(c.aggregates),d.aggregates.length||(d.aggregates=i(a)),d.drilldown=d.drilldown.concat(c.rows),d.drilldown=d.drilldown.concat(c.columns),d.pagesize=1e4*d.pagesize,d.order=asArray(d.order);var e=c.rows.concat(c.columns);for(var g in e){var j=e[g];-1==d.order.indexOf(j)&&d.order.push(j)}var k=b.get(f.getApiUrl("aggregate"),f.queryParams(d));k.then(function(b){h(b.data,d,a,c)})},h=function(a,b,d,e){if(d){e.rows=asArray(e.rows),e.columns=asArray(e.columns);var f=d.aggregates.filter(function(b){return-1!=a.aggregates.indexOf(b.ref)}),g={},h=[],i=[],j=[],k=[],l=[];for(var m in a.cells){var n=function(a){return o[a]},o=a.cells[m],p=e.rows.map(n),q=p.join(VAL_KEY),r=e.columns.map(n);for(var s in f){var t=f[s],u=t.label||t.name,v=r.concat([u]);column_set=v.join(VAL_KEY),-1==k.indexOf(q)&&(k.push(q),p.key=q,i.push(p)),-1==l.indexOf(column_set)&&(l.push(column_set),j.push(v));var w=[q,column_set].join(POS_KEY);g[w]=o[t.name]}}for(var m in k){var x=k[m],y=[];for(var z in l){var A=l[z],w=[x,A].join(POS_KEY);y.push(g[w]||a.aggregates.map(function(a){return void 0}))}h.push(y)}c.rows=i,c.columns=j,c.table=h}};a.$on(f.modelUpdate,function(a,b,c){g(b,c)});var i=function(a){var b=[];for(var c in a.aggregates){var d=a.aggregates[c];b.push(d.ref)}return b};f.init({rows:{label:"Rows",addLabel:"add row",types:["attributes"],defaults:[],sortId:0,multiple:!0},columns:{label:"Columns",addLabel:"add column",types:["attributes"],defaults:[],sortId:1,multiple:!0},aggregates:{label:"Values",addLabel:"add value",types:["aggregates"],defaults:i,sortId:2,multiple:!0}})}}}]),ngCubes.directive("cubesFacts",["$rootScope","$http","$q",function(a,b,c){return{restrict:"EA",require:"^cubes",scope:{drilldown:"="},templateUrl:"angular-cubes-templates/facts.html",link:function(d,e,f,g){var h={};d.page=0,d.data=[],d.columns=[],d.pagerCtx={};var i=function(a,d){var e=g.getQuery();e.fields=asArray(d.fields),0==e.fields.length&&(e.fields=k(a));var f=angular.copy(e);f.drilldown=f.fields=[],f.page=0;var h=b.get(g.getApiUrl("facts"),g.queryParams(e)),i=b.get(g.getApiUrl("aggregate"),g.queryParams(f));c.all([h,i]).then(function(a){j(a[0].data,a[1].data,e,d)})},j=function(a,b,c,e){if(!a.length)return d.columns=[],d.data=[],void(d.pagerCtx={});var f=a[0],g=[];for(var i in f)g.push(i);g=g.sort();var j=[],k=null,l=0;for(var m in g){var n=h[g[m]],o=n.dimension?n.dimension:n;o.name==k?(j[l].span+=1,n.span=0):(n.span=1,n.label=n.label||n.name,n.header=o.label||o.name,n.hide=n.header==n.label,k=o.name,l=j.length),j.push(n)}d.columns=j,d.data=a,d.pagerCtx={page:c.page,pagesize:c.pagesize,total:b.summary.fact_count}},k=function(a){var b=[];for(var c in a.measures){var d=a.measures[c];b.push(d.ref)}for(var c in a.dimensions){var e=a.dimensions[c];for(var f in e.levels){var g=e.levels[f];for(var h in g.attributes){var i=g.attributes[h];i.name==g.label_attribute&&b.push(i.ref)}}}return b};a.$on(g.modelUpdate,function(a,b,c){for(var d in b.measures){var e=b.measures[d];e.numeric=!0,h[e.ref]=e}for(var f in b.dimensions){var g=b.dimensions[f];for(var j in g.levels){var k=g.levels[j];for(var l in k.attributes){var m=k.attributes[l];m.dimension=g,h[m.ref]=m}}}i(b,c)}),g.init({fields:{label:"Columns",addLabel:"add column",types:["attributes","measures"],defaults:k,sortId:0,multiple:!0}})}}}]),ngCubes.directive("cubesPanel",["$rootScope",function(a){return{restrict:"EA",require:"^cubes",scope:{},templateUrl:"angular-cubes-templates/panel.html",link:function(b,c,d,e){b.state={},b.axes=[],b.filters=[];var f=function(){e.setState(b.state)};b.add=function(a,c){-1==a.selected.indexOf(c)&&(a.selected.push(c),b.state[a.name]=a.selected,f())},b.remove=function(a,c){var d=a.selected.indexOf(c);-1!=d&&(a.selected.splice(d,1),b.state[a.name]=a.selected,f())};var g=function(a){var b=[];for(var c in a.dimensions){var d=a.dimensions[c];for(var e in d.levels){var f=d.levels[e];for(var g in f.attributes){var h=f.attributes[g];h.dimension=d,h.type="attributes",h.sortKey="1."+d.name+".",h.name!=f.label_attribute&&(h.subLabel=h.label,h.sortKey=h.sortKey+h.name),h.label=d.label,b.push(h)}}}for(var g in a.aggregates){var i=a.aggregates[g];i.type="aggregates",i.sortKey="2.."+i.name,b.push(i)}for(var j in a.measures){var k=a.measures[j];k.type="measures",k.sortKey="3.."+k.name,b.push(k)}return b},h=function(a,b){return a.sortKey.localeCompare(b.sortKey)},i=function(a,b,c){var d=[];if(!e.queryModel)return[];for(var f in e.queryModel){var g=e.queryModel[f];g.name=f,g.sortId=g.sortId||1,g.available=[],g.active=[],g.selected=asArray(a[f]),g.selected.length||(angular.isFunction(g.defaults)?g.selected=g.defaults(b):g.selected=asArray(g.defaults)),g.available=g.available.sort(h),g.active=g.active.sort(h);for(var i in c){var j=c[i];-1!=g.selected.indexOf(j.ref)?g.active.push(j):-1!=g.types.indexOf(j.type)&&g.available.push(j)}d.push(g)}return d.sort(function(a,b){return a.sortId-b.sortId})},j=function(a){var b=[];for(var c in a){var d=a[c];"attributes"==d.type&&b.push(d)}return b.sort(h)};a.$on(e.modelUpdate,function(a,c,d){b.state=d;var e=g(c);b.axes=i(d,c,e),b.filters=j(e)})}}}]),ngCubes.directive("cubesWorkspace",["$location",function(a){return{restrict:"EA",scope:{slicer:"@",cube:"@"},templateUrl:"angular-cubes-templates/workspace.html",link:function(b,c,d){b.state={},b.view=a.search().view||"facts",b.setView=function(b){var c=a.search();c.view=b,a.search(c)}}}}]),angular.module("ngCubes.templates",["angular-cubes-templates/crosstab.html","angular-cubes-templates/cubes.html","angular-cubes-templates/facts.html","angular-cubes-templates/pager.html","angular-cubes-templates/panel.html","angular-cubes-templates/workspace.html"]),angular.module("angular-cubes-templates/crosstab.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/crosstab.html",'<div class="table-cubes" ng-show="rows.length">\n  <table class="table table-bordered table-condensed">\n    <thead>\n      <tr ng-repeat="x in columns[0]">\n        <th ng-repeat="r in rows[0]"></th>\n        <th ng-repeat="c in columns">\n          {{c[$parent.$index]}}\n        </th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr ng-repeat="row in rows">\n        <th ng-repeat="r in row">\n          {{r}}\n        </th>\n        <td ng-repeat="val in table[$index] track by $index" class="numeric">\n          {{val | numeric}}\n        </td>\n      </tr>\n    </tbody>\n  </table>\n</div>\n\n<div class="alert alert-info" ng-hide="rows.length">\n  <strong>You have not selected any data.</strong> Please choose a set of rows \n  and columns to generate a cross-table.\n</div>\n')}]),angular.module("angular-cubes-templates/cubes.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/cubes.html",'<div class="cubes-frame" ng-transclude>\n</div>\n')}]),angular.module("angular-cubes-templates/facts.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/facts.html",'<div class="table-cubes" ng-show="data">\n  <table class="table table-bordered table-condensed">\n    <thead>\n      <tr>\n        <th ng-repeat="c in columns" ng-if="c.span" colspan="{{c.span}}">\n          {{ c.header }}\n        </th>\n      </tr>\n      <tr>\n        <th ng-repeat="c in columns">\n          <span ng-hide="c.hide">{{ c.label }}</span>\n        </th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr ng-repeat="row in data">\n        <td ng-repeat="c in columns" ng-class="{\'numeric\': c.numeric}">\n          <span ng-if="c.numeric">\n            {{ row[c.ref] | numeric }}\n          </span>\n          <span ng-if="!c.numeric">\n            {{ row[c.ref] }}\n          </span>\n        </td>\n      </tr>\n    </tbody>\n  </table>\n</div>\n<cubes-pager context="pagerCtx"></cubes-pager>\n')}]),angular.module("angular-cubes-templates/pager.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/pager.html",'<ul ng-show="showPager" class="pagination pagination-sm">\n  <li ng-class="{\'disabled\': !hasPrev}">\n    <a class="ng-link" ng-click="setPage(current - 1)">&laquo;</a>\n  </li>\n  <li ng-repeat="page in pages" ng-class="{\'active\': page.current}">\n    <a class="ng-link" ng-click="setPage(page.page)">{{page.page + 1}}</a>\n  </li>\n  <li ng-class="{\'disabled\': !hasNext}">\n    <a class="ng-link" ng-click="setPage(current + 1)">&raquo;</a>\n  </li>\n</ul>\n')}]),angular.module("angular-cubes-templates/panel.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/panel.html",'<div class="panel panel-default" ng-repeat="axis in axes">\n  <div class="panel-heading">\n    <strong>{{axis.label}}</strong>\n\n    <div class="btn-group" dropdown ng-show="axis.available.length">\n      &mdash;\n      <a dropdown-toggle class="ng-link">{{axis.addLabel}}</a>\n      <ul class="dropdown-menu" role="menu">\n        <li ng-repeat="opt in axis.available">\n          <a ng-click="add(axis, opt.ref)">\n            <strong>{{opt.label}}</strong>\n            <small>{{opt.subLabel}}</small>\n          </a>\n        </li>\n      </ul>\n    </div>\n  </div>\n  <table class="table">\n    <tr ng-repeat="opt in axis.active">\n      <td colspan="2">\n        <span class="pull-right">\n          <a ng-click="remove(axis, opt.ref)" class="ng-link">\n            <i class="fa fa-times"></i>\n          </a>\n        </span>\n        <strong>{{opt.label}}</strong>\n        <small>{{opt.subLabel}}</small>\n      </td>\n    </tr>\n  </table>\n</div>\n\n\n<div class="panel panel-default">\n  <div class="panel-heading">\n    <strong>Filters</strong>\n\n    <div class="btn-group" dropdown ng-show="filters.length">\n      &mdash;\n      <a dropdown-toggle class="ng-link">add filter</a>\n      <ul class="dropdown-menu" role="menu">\n        <li ng-repeat="filter in filters">\n          <a ng-click="addFilter(filter)">\n            <strong>{{filter.label}}</strong>\n            <small>{{filter.subLabel}}</small>\n          </a>\n        </li>\n      </ul>\n    </div>\n  </div>\n  <table class="table">\n    <!--tr ng-repeat="opt in axis.active">\n      <td colspan="2">\n        <span class="pull-right">\n          <a ng-click="remove(axis, opt.ref)" class="ng-link">\n            <i class="fa fa-times"></i>\n          </a>\n        </span>\n        <strong>{{opt.label}}</strong>\n        <small>{{opt.subLabel}}</small>\n      </td>\n    </tr-->\n  </table>\n</div>\n\n')}]),angular.module("angular-cubes-templates/workspace.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/workspace.html",'<cubes slicer="{{slicer}}" cube="{{cube}}" state="state">\n  <div class="row">\n    <div class="col-md-9">\n      <div ng-if="view == \'crosstab\'">\n        <cubes-crosstab></cubes-crosstab>\n      </div>\n      <div ng-if="view == \'facts\'">\n        <cubes-facts></cubes-facts>\n      </div>\n    </div>\n    <div class="col-md-3">\n      <div class="btn-group spaced" role="group">\n        <a class="btn btn-default"\n          ng-class="{\'active\': view == \'facts\'}"\n          ng-click="setView(\'facts\')">\n          <i class="fa fa-table"></i> Line items\n        </a>\n        <a class="btn btn-default"\n          ng-class="{\'active\': view == \'crosstab\'}"\n          ng-click="setView(\'crosstab\')">\n          <i class="fa fa-cubes"></i> Crosstab\n        </a>\n        <!--a type="button" class="btn btn-default disabled">\n          <i class="fa fa-bar-chart"></i>\n        </a-->\n      </div>\n      <cubes-panel></cubes-panel>\n    </div>\n  </div>\n</cubes>\n')}]);