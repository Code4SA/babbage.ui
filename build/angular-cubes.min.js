/*! angular-cubes 2015-06-28 */
function asArray(a){return objs=a?a:[],angular.isArray(objs)?objs:[objs]}var makeSignal=function(a){return"cubes_"+Math.random().toString(36).replace(/[^a-z]+/g,"")};String.prototype.endsWith||(String.prototype.endsWith=function(a,b){var c=this.toString();(void 0===b||b>c.length)&&(b=c.length),b-=a.length;var d=c.indexOf(a,b);return-1!==d&&d===b});var ngCubes=angular.module("ngCubes",["ngCubes.templates"]),numberFormat=d3.format("0,000");ngCubes.filter("numeric",function(){return function(a){var b=parseFloat(a);return isNaN(b)?"-":numberFormat(Math.round(b))}}),ngCubes.factory("cubesApi",["$http","$q",function(a,b){var c={},d=function(a,b,c){var d=a.slice(),d=d.endsWith("/")?d.slice(0,d.length-1):d,d=d+"/cube/"+b+"/"+c;return d},e=function(b){return angular.isDefined(c[b])||(c[b]=a.get(b)),c[b]},f=function(a,b){return e(d(a,b,"model"))},g=function(a,b,c){return e(d(a,b,"members/"+c))},h=function(){c={}};return{getUrl:d,getModel:f,getDimensionMembers:g,flush:h}}]),ngCubes.directive("cubes",["$http","$rootScope","$location","cubesApi",function(a,b,c,d){return{restrict:"E",transclude:!0,scope:{slicer:"@",cube:"@",state:"="},templateUrl:"angular-cubes-templates/cubes.html",controller:["$scope",function(a){var e=this,f=angular.extend({},a.state||{},c.search());e.dataUpdate=makeSignal(),e.modelUpdate=makeSignal(),e.queryModel={},e.init=function(c){e.queryModel=c,d.getModel(a.slicer,a.cube).then(function(a){b.$broadcast(e.modelUpdate,a.data,f)})},e.getState=function(){return f},e.setState=function(a){c.search(a)},e.getApiUrl=function(b){return d.getUrl(a.slicer,a.cube,b)},e.getDimensionMembers=function(b){return d.getDimensionMembers(a.slicer,a.cube,b)},e.getQuery=function(){var a={drilldown:[],aggregates:[],cut:f.cut||[],page:f.page||0,pagesize:f.pagesize||100,order:[]};return a},e.queryParams=function(a){for(var b in a)angular.isArray(a[b])&&(-1==["order","fields"].indexOf(b)?a[b]=a[b].join("|"):a[b]=a[b].join(",")),a[b]=a[b]+"",a[b].length||delete a[b];return{params:a}}}]}}]),ngCubes.directive("cubesPager",["$timeout","$location",function(a,b){return{restrict:"E",scope:{context:"="},templateUrl:"angular-cubes-templates/pager.html",link:function(a,c,d,e){a.showPager=!1,a.hasPrev=!1,a.hasNext=!1,a.pages=[],a.cur=0,a.num=0,a.$watch("context",function(b){if(a.context&&!(a.context.total<=a.context.pagesize)){a.current=parseInt(a.context.page,10)||0,a.num=Math.ceil(a.context.total/a.context.pagesize);var c=[],d=a.num,e=3,f=a.current-e,g=a.current+e;0>f&&(f=0,g=Math.min(2*e+1,d)),g>d&&(g=d,f=Math.max(1,d-2*e+1));for(var h=f;g>=h;h++)c.push({page:h,current:h==a.current});a.hasPrev=a.current>0,a.hasNext=a.current<d,a.showPager=d>1,a.pages=c}}),a.setPage=function(c){if(c>=0&&c<=a.num){var d=b.search();d.page=c,b.search(d)}}}}}]);var VAL_KEY="@@@@",POS_KEY="!@!@";ngCubes.directive("cubesCrosstab",["$rootScope","$http",function(a,b){return{restrict:"EA",require:"^cubes",scope:{drilldown:"="},templateUrl:"angular-cubes-templates/crosstab.html",link:function(c,d,e,f){c.queryLoaded=!1,c.columns=[],c.rows=[],c.table=[];var g=function(a,c){c.rows=asArray(c.rows),c.columns=asArray(c.columns),c.aggregates=asArray(c.aggregates);var d=f.getQuery();d.aggregates=d.aggregates.concat(c.aggregates),d.aggregates.length||(d.aggregates=i(a)),d.drilldown=d.drilldown.concat(c.rows),d.drilldown=d.drilldown.concat(c.columns),d.page=0,d.pagesize=1e4*d.pagesize,d.order=asArray(d.order);var e=c.rows.concat(c.columns);for(var g in e){var j=e[g];-1==d.order.indexOf(j)&&d.order.push(j)}var k=b.get(f.getApiUrl("aggregate"),f.queryParams(d));k.then(function(b){h(b.data,d,a,c)})},h=function(a,b,d,e){e.rows=asArray(e.rows),e.columns=asArray(e.columns);var f=d.aggregates.filter(function(b){return-1!=a.aggregates.indexOf(b.ref)}),g={},h=[],i=[],j=[],k=[],l=[];for(var m in a.cells){var n=function(a){return o[a]},o=a.cells[m],p=e.rows.map(n),q=p.join(VAL_KEY),r=e.columns.map(n);for(var s in f){var t=f[s],u=t.label||t.name,v=r.concat([u]);column_set=v.join(VAL_KEY),-1==k.indexOf(q)&&(k.push(q),p.key=q,i.push(p)),-1==l.indexOf(column_set)&&(l.push(column_set),j.push(v));var w=[q,column_set].join(POS_KEY);g[w]=o[t.name]}}for(var m in k){var x=k[m],y=[];for(var z in l){var A=l[z],w=[x,A].join(POS_KEY);y.push(g[w]||a.aggregates.map(function(a){return void 0}))}h.push(y)}c.rows=i,c.columns=j,c.table=h,c.queryLoaded=!0};a.$on(f.modelUpdate,function(a,b,c){g(b,c)});var i=function(a){var b=[];for(var c in a.aggregates){var d=a.aggregates[c];b.push(d.ref)}return b};f.init({columns:{label:"Columns",addLabel:"add column",types:["attributes"],defaults:[],sortId:0,multiple:!0},rows:{label:"Rows",addLabel:"add row",types:["attributes"],defaults:[],sortId:1,multiple:!0},aggregates:{label:"Values",addLabel:"add value",types:["aggregates"],defaults:i,sortId:2,multiple:!0}})}}}]),ngCubes.directive("cubesFacts",["$rootScope","$http","$q","slugifyFilter",function(a,b,c,d){return{restrict:"EA",require:"^cubes",scope:{drilldown:"="},templateUrl:"angular-cubes-templates/facts.html",link:function(e,f,g,h){var i={};e.page=0,e.data=[],e.columns=[],e.pagerCtx={};var j=function(a,d){var e=h.getQuery();e.fields=asArray(d.fields),0==e.fields.length&&(e.fields=l(a));var f=angular.copy(e);f.drilldown=f.fields=[],f.page=0;var g=b.get(h.getApiUrl("facts"),h.queryParams(e)),i=b.get(h.getApiUrl("aggregate"),h.queryParams(f));c.all([g,i]).then(function(a){k(a[0].data,a[1].data,e,d)})},k=function(a,b,c,d){if(!a.length)return e.columns=[],e.data=[],void(e.pagerCtx={});var f=a[0],g=[];for(var h in f)g.push(h);g=g.sort();var j=[],k=null,l=0;for(var m in g){var n=i[g[m]],o=n.dimension?n.dimension:n;o.name==k?(j[l].span+=1,n.span=0):(n.span=1,n.label=n.label||n.name,n.header=o.label||o.name,n.hide=n.hideLabel,k=o.name,l=j.length),j.push(n)}e.columns=j,e.data=a,e.pagerCtx={page:c.page,pagesize:c.pagesize,total:b.summary.fact_count}},l=function(a){var b=[];for(var c in a.measures){var d=a.measures[c];b.push(d.ref)}for(var c in a.dimensions){var e=a.dimensions[c];for(var f in e.levels){var g=e.levels[f];for(var h in g.attributes){var i=g.attributes[h];i.name==g.label_attribute&&b.push(i.ref)}}}return b};a.$on(h.modelUpdate,function(a,b,c){for(var e in b.measures){var f=b.measures[e];f.numeric=!0,f.hideLabel=!0,i[f.ref]=f}for(var g in b.dimensions){var h=b.dimensions[g];for(var k in h.levels){var l=h.levels[k];for(var m in l.attributes){var n=l.attributes[m];n.dimension=h,n.hideLabel=d(n.label)==d(h.label),i[n.ref]=n}}}j(b,c)}),h.init({fields:{label:"Columns",addLabel:"add column",types:["attributes","measures"],defaults:l,sortId:0,multiple:!0}})}}}]),ngCubes.directive("cubesPanel",["$rootScope","slugifyFilter",function(a,b){return{restrict:"EA",require:"^cubes",scope:{},templateUrl:"angular-cubes-templates/panel.html",link:function(c,d,e,f){c.state={},c.axes=[],c.filterAttributes=[],c.filters=[];var g=function(){f.setState(c.state)};c.add=function(a,b){-1==a.selected.indexOf(b)&&(a.selected.push(b),c.state[a.name]=a.selected,g())},c.remove=function(a,b){var d=a.selected.indexOf(b);-1!=d&&(a.selected.splice(d,1),c.state[a.name]=a.selected,g())};var h=function(a){var c=[];for(var d in a.dimensions){var e=a.dimensions[d];for(var f in e.levels){var g=e.levels[f];for(var h in g.attributes){var i=angular.copy(g.attributes[h]);i.type="attributes",b(e.label)!=b(i.label)&&(i.subLabel=""+i.label),i.sortKey="0"+e.label+i.label,i.label=e.label,i.cardinality=g.cardinality,c.push(i)}}}for(var h in a.aggregates){var j=a.aggregates[h];j.type="aggregates",j.sortKey="1"+j.name,c.push(j)}for(var k in a.measures){var l=a.measures[k];l.type="measures",l.sortKey="2"+l.name,c.push(l)}return c},i=function(a,b){return a.label.localeCompare(b.label)},j=function(a,b,c){var d=[];if(!f.queryModel)return[];for(var e in f.queryModel){var g=f.queryModel[e];g.name=e,g.sortId=g.sortId||1,g.available=[],g.active=[],g.selected=asArray(a[e]),g.selected.length||(angular.isFunction(g.defaults)?g.selected=g.defaults(b):g.selected=asArray(g.defaults)),g.available=g.available.sort(i),g.active=g.active.sort(i);for(var h in c){var j=c[h];-1!=g.selected.indexOf(j.ref)?g.active.push(j):-1!=g.types.indexOf(j.type)&&g.available.push(j)}d.push(g)}return d.sort(function(a,b){return a.sortId-b.sortId})},k=function(a){var b=[];for(var c in a){var d=a[c];"attributes"==d.type&&"high"!=d.cardinality&&b.push(d)}return b.sort(i)},l=function(a){return a.split(".",1)},m=function(a,b){return b.data.data.map(function(b){return b[a]})},n=function(a){for(var b in c.filterAttributes){var d=c.filterAttributes[b];if(d.ref==a)return d}},o=function(a){var b=[],c=asArray(a.cut);for(var d in c){var e=c[d];if(-1!=e.indexOf(":")){var g=e.split(":",1)[0],h=e.slice(g.length+1).split(";");for(var i in h){var j={ref:g,attr:n(g),value:h[i],values:[],editMode:!1};f.getDimensionMembers(l(g)).then(function(a){j.values=m(g,a)}),b.push(j)}}}return b};c.addFilter=function(a){f.getDimensionMembers(l(a.ref)).then(function(b){c.filters.push({ref:a.ref,attr:a,editMode:!0,values:m(a.ref,b)})})},c.removeFilter=function(a){var b=c.filters.indexOf(a);-1!=b&&(c.filters.splice(b,1),c.updateFilters())},c.toggleEditFilter=function(a){a.editMode=!a.editMode},c.setFilter=function(a,b){c.toggleEditFilter(a),c.updateFilters()},c.updateFilters=function(){var a={};for(var b in c.filters){var d=c.filters[b];angular.isUndefined(a[d.ref])&&(a[d.ref]=[]),a[d.ref].push(d.value)}var e=[];for(var f in a){var h=a[f],i=h.join(";");cut=f+":"+i,e.push(cut)}c.state.page=0,c.state.cut=e,g()},a.$on(f.modelUpdate,function(a,b,d){c.state=d;var e=h(b);c.axes=j(d,b,e),c.filterAttributes=k(e),c.filters=o(d)})}}}]),ngCubes.directive("cubesWorkspace",["$location",function(a){return{restrict:"EA",scope:{slicer:"@",cube:"@"},templateUrl:"angular-cubes-templates/workspace.html",link:function(b,c,d){b.state={},b.view=a.search().view||"facts",b.setView=function(b){var c=a.search();c.view=b,a.search(c)}}}}]),angular.module("ngCubes.templates",["angular-cubes-templates/crosstab.html","angular-cubes-templates/cubes.html","angular-cubes-templates/facts.html","angular-cubes-templates/pager.html","angular-cubes-templates/panel.html","angular-cubes-templates/workspace.html"]),angular.module("angular-cubes-templates/crosstab.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/crosstab.html",'<div class="table-cubes" ng-show="rows.length">\n  <table class="table table-bordered table-condensed">\n    <thead>\n      <tr ng-repeat="x in columns[0]">\n        <th ng-repeat="r in rows[0]"></th>\n        <th ng-repeat="c in columns">\n          {{c[$parent.$index]}}\n        </th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr ng-repeat="row in rows">\n        <th ng-repeat="r in row">\n          {{r}}\n        </th>\n        <td ng-repeat="val in table[$index] track by $index" class="numeric">\n          {{val | numeric}}\n        </td>\n      </tr>\n    </tbody>\n  </table>\n</div>\n\n<div class="table-cubes" ng-hide="rows.length || !queryLoaded">\n  <div class="alert alert-info">\n    <strong>You have not selected any data.</strong> Please choose a set of rows \n    and columns to generate a cross-table.\n  </div>\n</div>\n')}]),angular.module("angular-cubes-templates/cubes.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/cubes.html",'<div class="cubes-frame" ng-transclude>\n</div>\n')}]),angular.module("angular-cubes-templates/facts.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/facts.html",'<div class="table-cubes" ng-show="data">\n  <table class="table table-bordered table-striped table-condensed">\n    <thead>\n      <tr>\n        <th ng-repeat="c in columns" ng-if="c.span" colspan="{{c.span}}">\n          {{ c.header }}\n          <span class="sublabel" ng-hide="c.hide">{{ c.label }}</span>\n        </th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr ng-repeat="row in data">\n        <td ng-repeat="c in columns" ng-class="{\'numeric\': c.numeric}" class="simple">\n          <span ng-if="c.numeric">\n            {{ row[c.ref] | numeric }}\n          </span>\n          <span ng-if="!c.numeric">\n            {{ row[c.ref] }}\n          </span>\n        </td>\n      </tr>\n    </tbody>\n  </table>\n</div>\n<cubes-pager context="pagerCtx"></cubes-pager>\n')}]),angular.module("angular-cubes-templates/pager.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/pager.html",'<ul ng-show="showPager" class="pagination pagination-sm">\n  <li ng-class="{\'disabled\': !hasPrev}">\n    <a class="ng-link" ng-click="setPage(current - 1)">&laquo;</a>\n  </li>\n  <li ng-repeat="page in pages" ng-class="{\'active\': page.current}">\n    <a class="ng-link" ng-click="setPage(page.page)">{{page.page + 1}}</a>\n  </li>\n  <li ng-class="{\'disabled\': !hasNext}">\n    <a class="ng-link" ng-click="setPage(current + 1)">&raquo;</a>\n  </li>\n</ul>\n')}]),angular.module("angular-cubes-templates/panel.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/panel.html",'<div class="panel panel-default" ng-repeat="axis in axes">\n  <div class="panel-heading">\n    <strong>{{axis.label}}</strong>\n\n    <div class="btn-group" dropdown ng-show="axis.available.length">\n      &mdash;\n      <a dropdown-toggle class="ng-link">{{axis.addLabel}}</a>\n      <ul class="dropdown-menu" role="menu">\n        <li ng-repeat="opt in axis.available">\n          <a ng-click="add(axis, opt.ref)">\n            <strong>{{opt.label}}</strong>\n            {{opt.subLabel}}\n          </a>\n        </li>\n      </ul>\n    </div>\n  </div>\n  <table class="table">\n    <tr ng-repeat="opt in axis.active">\n      <td colspan="2">\n        <span class="pull-right">\n          <a ng-click="remove(axis, opt.ref)" class="ng-link">\n            <i class="fa fa-times"></i>\n          </a>\n        </span>\n        <strong>{{opt.label}}</strong>\n        {{opt.subLabel}}\n      </td>\n    </tr>\n  </table>\n</div>\n\n\n<div class="panel panel-default">\n  <div class="panel-heading">\n    <strong>Filters</strong>\n\n    <div class="btn-group" dropdown ng-show="filterAttributes.length">\n      &mdash;\n      <a dropdown-toggle class="ng-link">add filter</a>\n      <ul class="dropdown-menu" role="menu">\n        <li ng-repeat="attr in filterAttributes">\n          <a ng-click="addFilter(attr)">\n            <strong>{{attr.label}}</strong>\n            {{attr.subLabel}}\n          </a>\n        </li>\n      </ul>\n    </div>\n  </div>\n  <table class="table table-panel">\n    <tbody ng-repeat="filter in filters">\n      <tr>\n        <td colspan="2">\n          <strong>{{filter.attr.label}}</strong>\n          {{filter.attr.subLabel}}\n        </td>\n        <td width="1%">\n          <span class="pull-right">\n            <a ng-click="removeFilter(filter)" class="ng-link">\n              <i class="fa fa-times"></i>\n            </a>\n          </span>\n        </td>\n      </tr>\n      <tr class="adjoined">\n        <td width="1%" class="middle">\n          is\n        </td>\n        <td width="90%">\n          <div ng-hide="filter.editMode">\n            {{filter.value}}\n          </div>\n          <div ng-show="filter.editMode">\n            <ui-select ng-model="filter.value" disable-search="false" on-select="setFilter(filter, $item, $model)">\n              <ui-select-match placeholder="Pick one...">{{$select.selected}}</ui-select-match>\n              <ui-select-choices repeat="v in filter.values | filter: $select.search track by $index">\n                 <div ng-bind="v"></div>\n              </ui-select-choices>\n            </ui-select>\n          </div>\n        </td>\n        <td class="middle">\n          <span class="pull-right">\n            <a ng-click="toggleEditFilter(filter)" class="ng-link">\n              <i class="fa fa-edit"></i>\n            </a>\n          </span>\n        </td>\n      </tr>\n    </tbody>\n  </table>\n</div>\n\n')}]),angular.module("angular-cubes-templates/workspace.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/workspace.html",'<cubes slicer="{{slicer}}" cube="{{cube}}" state="state">\n  <div class="row">\n    <div class="col-md-9">\n      <div ng-if="view == \'crosstab\'">\n        <cubes-crosstab></cubes-crosstab>\n      </div>\n      <div ng-if="view == \'facts\'">\n        <cubes-facts></cubes-facts>\n      </div>\n    </div>\n    <div class="col-md-3">\n      <div class="btn-group spaced" role="group">\n        <a class="btn btn-default"\n          ng-class="{\'active\': view == \'facts\'}"\n          ng-click="setView(\'facts\')">\n          <i class="fa fa-table"></i> Line items\n        </a>\n        <a class="btn btn-default"\n          ng-class="{\'active\': view == \'crosstab\'}"\n          ng-click="setView(\'crosstab\')">\n          <i class="fa fa-cubes"></i> Pivot table\n        </a>\n        <!--a type="button" class="btn btn-default disabled">\n          <i class="fa fa-bar-chart"></i>\n        </a-->\n      </div>\n      <cubes-panel></cubes-panel>\n    </div>\n  </div>\n</cubes>\n')}]);