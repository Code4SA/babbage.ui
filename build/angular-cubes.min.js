/*! angular-cubes 2015-06-17 */
function asArray(a){return objs=a?a:[],angular.isArray(objs)?objs:[objs]}var VAL_KEY="@@@@",POS_KEY="!@!@";ngCubes.directive("cubesCrosstab",["$rootScope",function(a){return{restrict:"EA",require:"^cubes",scope:{drilldown:"="},templateUrl:"angular-cubes-templates/crosstab.html",link:function(b,c,d,e){var f=null;b.columns=[],b.rows=[],b.table=[],e.registerQueryProcessor(function(a,b){b.rows=asArray(b.rows),b.columns=asArray(b.columns),a.pagesize=1e4*a.pagesize,a.order=asArray(a.order);var c=b.rows.concat(b.columns);for(var d in c){var e=c[d];-1==a.order.indexOf(e)&&a.order.push(e)}return a.order=a.order.join(","),a}),a.$on(e.modelUpdate,function(a,b){f=b}),a.$on(e.dataUpdate,function(a,c,d,e){if(f){e.rows=asArray(e.rows),e.columns=asArray(e.columns);var g=f.aggregates.filter(function(a){return-1!=c.aggregates.indexOf(a.ref)}),h={},i=[],j=[],k=[],l=[],m=[];for(var n in c.cells){var o=function(a){return p[a]},p=c.cells[n],q=e.rows.map(o),r=q.join(VAL_KEY),s=e.columns.map(o);for(var t in g){var u=g[t],v=u.label||u.name,w=s.concat([v]);column_set=w.join(VAL_KEY),-1==l.indexOf(r)&&(l.push(r),q.key=r,j.push(q)),-1==m.indexOf(column_set)&&(m.push(column_set),k.push(w));var x=[r,column_set].join(POS_KEY);h[x]=p[u.name]}}for(var n in l){var y=l[n],z=[];for(var A in m){var B=m[A],x=[y,B].join(POS_KEY);z.push(h[x]||c.aggregates.map(function(a){return void 0}))}i.push(z)}b.rows=j,b.columns=k,b.table=i}}),e.init({rows:{label:"Rows",multiple:!0},columns:{label:"Columns",multiple:!0}})}}}]);var ngCubes=angular.module("ngCubes",["ngCubes.templates"]),makeSignal=function(a){return"cubes_"+Math.random().toString(36).replace(/[^a-z]+/g,"")};ngCubes.filter("numeric",function(){return function(a){return isNaN(parseFloat(a))?"-":numeral(a).format("0,0")}}),ngCubes.directive("cubes",["$http","$rootScope",function(a,b){return{restrict:"E",transclude:!0,scope:{slicer:"@",cube:"@",state:"=",changeState:"&"},templateUrl:"angular-cubes-templates/cubes.html",controller:["$scope",function(c){var d=this,e=c.state||{},f=[],g=c.slicer.slice(),g=g.endsWith("/")?g.slice(0,g.length-1):g,g=g+"/cube/"+c.cube;d.dataUpdate=makeSignal(),d.stateUpdate=makeSignal(),d.modelUpdate=makeSignal(),d.queryModel={},d.init=function(c){d.queryModel=c,a.get(g+"/model").then(function(a){b.$broadcast(d.modelUpdate,a.data),b.$broadcast(d.stateUpdate,e),d.query()})},d.getState=function(){return e},d.setState=function(a){e=a,b.$broadcast(d.stateUpdate,e),c.changeState&&c.changeState(e)},d.registerQueryProcessor=function(a){f.push(a)},d.getQuery=function(){var a={drilldown:[],aggregates:[],cut:[],page:0,pagesize:20,order:[],endpoint:"aggregate"};for(var b in f){var c=f[b];a=c(a,e)}for(var d in a)angular.isArray(a[d])&&(a[d]=a[d].join("|")),a[d]=a[d]+"",a[d].length||delete a[d];return a},d.query=function(){var c=d.getQuery(),f=c.endpoint;delete c.endpoint,a.get(g+"/"+f,{params:c}).then(function(a){b.$broadcast(d.dataUpdate,a.data,c,e)})}}]}}]),ngCubes.directive("cubesFacts",["$rootScope",function(a){return{restrict:"EA",require:"^cubes",scope:{drilldown:"="},templateUrl:"angular-cubes-templates/facts.html",link:function(b,c,d,e){var f={};b.page=0,b.data=[],b.columns=[],e.registerQueryProcessor(function(a,c){return a.endpoint="facts",a.page=b.page,a}),a.$on(e.modelUpdate,function(a,b){for(var c in b.measures){var d=b.measures[c];f[d.ref]={ref:d.ref,numeric:!0,label:d.label||d.name}}for(var e in b.dimensions){var g=b.dimensions[e];for(var h in g.levels){var i=g.levels[h];for(var j in i.attributes){var k=i.attributes[j];f[k.ref]={ref:k.ref,label:k.label||k.name}}}}}),a.$on(e.dataUpdate,function(a,c,d,e){if(b.data=c,c.length){var g=c[0];columns=[];for(var h in g)columns.push(f[h]);b.columns=columns}}),e.init({columns:{label:"Columns",multiple:!0}})}}}]),ngCubes.directive("cubesPanel",["$rootScope",function(a){return{restrict:"EA",require:"^cubes",scope:{},templateUrl:"angular-cubes-templates/panel.html",link:function(b,c,d,e){b.model=null,b.state={};var f={},g=[],h=function(){e.setState(b.state),e.query()};b.getSelectedAggregates=function(){var a=[],c=b.model?b.model.aggregates||[]:[];for(var d in c)-1!=b.state.aggregates.indexOf(c[d].name)&&a.push(c[d]);return a},b.getAvailableAggregates=function(){var a=[],c=b.model?b.model.aggregates||[]:[];for(var d in c)-1==b.state.aggregates.indexOf(c[d].name)&&a.push(c[d]);return a},b.addAggregate=function(a){b.state.aggregates.push(a.name),h()},b.removeAggregate=function(a){var c=b.state.aggregates.indexOf(a.name);-1!=c&&(b.state.aggregates.splice(c,1),h())},b.getAvailableAttributes=function(){var a={};for(var b in f)-1==g.indexOf(b)&&(a[b]=f[b]);return a},b.getSelectedAttributes=function(a){var c={};for(var d in f)-1!=b.state[a].indexOf(d)&&(c[d]=f[d]);return c},b.hasAvailableAttributes=function(){for(var a in b.getAvailableAttributes())return!0;return!1},b.addAttribute=function(a,c){b.state[a].push(c),h()},b.removeAttribute=function(a,c){var d=b.state[a].indexOf(c);-1!=d&&(b.state[a].splice(d,1),h())},a.$on(e.modelUpdate,function(a,c){b.model=c,b.queryModel=e.queryModel,f={};for(var d in c.dimensions){var g=c.dimensions[d];for(var h in g.levels){var i=g.levels[h];for(var j in i.attributes){var k=i.attributes[j];k.dimension=g,f[k.ref]=k}}}}),a.$on(e.stateUpdate,function(a,c){if(c.aggregates=asArray(c.aggregates),b.model&&!c.aggregates.length)for(var d in b.model.aggregates)c.aggregates.push(b.model.aggregates[d].name);g=[];for(var e in b.queryModel){c[e]=asArray(c[e]);for(var f in c[e])g.push(c[e][f])}b.state=c}),e.registerQueryProcessor(function(a,c){a.aggregates=a.aggregates.concat(c.aggregates);for(var d in b.queryModel)a.drilldown=a.drilldown.concat(c[d]);return a})}}}]),angular.module("ngCubes.templates",["angular-cubes-templates/crosstab.html","angular-cubes-templates/cubes.html","angular-cubes-templates/facts.html","angular-cubes-templates/panel.html","angular-cubes-templates/workspace.html"]),angular.module("angular-cubes-templates/crosstab.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/crosstab.html",'<div class="table-cubes" ng-show="rows.length">\n  <table class="table table-bordered table-condensed">\n    <thead>\n      <tr ng-repeat="x in columns[0]">\n        <th ng-repeat="r in rows[0]"></th>\n        <th ng-repeat="c in columns">\n          {{c[$parent.$index]}}\n        </th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr ng-repeat="row in rows as ri">\n        <th ng-repeat="r in row">\n          {{r}}\n        </th>\n        <td ng-repeat="val in table[$index] track by $index" class="numeric">\n          {{val | numeric}}\n        </td>\n      </tr>\n    </tbody>\n  </table>\n</div>\n\n<div class="alert alert-info" ng-hide="rows.length">\n  <strong>You have not selected any data.</strong> Please choose a set of rows \n  and columns to generate a cross-table.\n</div>\n')}]),angular.module("angular-cubes-templates/cubes.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/cubes.html",'<div class="cubes-frame" ng-transclude>\n</div>\n')}]),angular.module("angular-cubes-templates/facts.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/facts.html",'<div class="table-cubes" ng-show="data">\n  <table class="table table-bordered table-condensed">\n    <thead>\n      <tr>\n        <th ng-repeat="c in columns">\n          {{ c.label }}\n        </th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr ng-repeat="row in data">\n        <td ng-repeat="c in columns" ng-class="{\'numeric\': c.numeric}">\n          <span ng-if="c.numeric">\n            {{ row[c.ref] | numeric }}\n          </span>\n          <span ng-if="!c.numeric">\n            {{ row[c.ref] }}\n          </span>\n        </td>\n      </tr>\n    </tbody>\n  </table>\n</div>\n')}]),angular.module("angular-cubes-templates/panel.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/panel.html",'<div class="panel panel-default" ng-repeat="(axis, spec) in queryModel">\n  <div class="panel-heading">\n    <strong>{{spec.label}}</strong>\n\n    <div class="btn-group" dropdown ng-show="hasAvailableAttributes()">\n      &mdash;\n      <a dropdown-toggle>Add {{spec.label.toLowerCase()}}</a>\n      <ul class="dropdown-menu" role="menu">\n        <li ng-repeat="(ref, a) in getAvailableAttributes()">\n          <a ng-click="addAttribute(axis, ref)">{{a.label}}</a>\n        </li>\n      </ul>\n    </div>\n  </div>\n  <table class="table">\n    <tr ng-repeat="(ref, a) in getSelectedAttributes(axis)">\n      <td colspan="2">\n        <span class="pull-right">\n          <a ng-click="removeAttribute(axis, ref)">\n            <i class="fa fa-times"></i>\n          </a>\n        </span>\n        {{a.label}}\n      </td>\n    </tr>\n  </table>\n</div>\n\n\n\n<div class="panel panel-default" ng-if="model">\n  <div class="panel-heading">\n    <strong>Values</strong>\n\n    <div class="btn-group" dropdown ng-show="getAvailableAggregates().length">\n      &mdash;\n      <a dropdown-toggle>Add value</a>\n      <ul class="dropdown-menu" role="menu">\n        <li ng-repeat="a in getAvailableAggregates()">\n          <a ng-click="addAggregate(a)">{{a.label}}</a>\n        </li>\n      </ul>\n    </div>\n  </div>\n  <table class="table">\n    <tr ng-repeat="a in getSelectedAggregates()">\n      <td colspan="2">\n        <span class="pull-right">\n          <a ng-click="removeAggregate(a)">\n            <i class="fa fa-times"></i>\n          </a>\n        </span>\n\n        {{a.label}}\n\n      </td>\n    </tr>\n  </table>\n</div>\n')}]),angular.module("angular-cubes-templates/workspace.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/workspace.html",'<cubes slicer="{{slicer}}" cube="{{cube}}" state="state" change-state="updateState(state)">\n  <div class="row">\n    <div class="col-md-9">\n      &nbsp;\n    </div>\n    <div class="col-md-3">\n      <div class="btn-group" role="group">\n        <button type="button" class="btn btn-default disabled" tooltip-placement="bottom"  tooltip="Table">\n          <i class="fa fa-table"></i>\n        </button>\n        <button type="button" class="btn btn-default active" tooltip-placement="bottom"  tooltip="Crosstab">\n          <i class="fa fa-cubes"></i>\n        </button>\n        <button type="button" class="btn btn-default disabled">\n          <i class="fa fa-bar-chart"></i>\n        </button>\n        <button type="button" class="btn btn-default disabled">\n          <i class="fa fa-line-chart"></i>\n        </button>\n        <button type="button" class="btn btn-default disabled">\n          <i class="fa fa-th-large"></i>\n        </button>\n      </div>\n    </div>\n  </div>\n  <br>\n  <div class="row">\n    <div class="col-md-9">\n      <!--cubes-crosstab></cubes-crosstab-->\n      <cubes-facts></cubes-facts>\n    </div>\n    <div class="col-md-3">\n      <cubes-panel></cubes-panel>\n    </div>\n  </div>\n</cubes>\n')}]),ngCubes.directive("cubesWorkspace",["$location",function(a){return{restrict:"EA",scope:{slicer:"@",cube:"@"},templateUrl:"angular-cubes-templates/workspace.html",link:function(b,c,d,e){b.state={};var f=function(){b.state=a.search()};b.updateState=function(b){a.search(b)},f()}}}]);