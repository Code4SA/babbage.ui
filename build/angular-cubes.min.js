/*! angular-cubes 2015-06-23 */
function asArray(a){return objs=a?a:[],angular.isArray(objs)?objs:[objs]}var makeSignal=function(a){return"cubes_"+Math.random().toString(36).replace(/[^a-z]+/g,"")};String.prototype.endsWith||(String.prototype.endsWith=function(a,b){var c=this.toString();(void 0===b||b>c.length)&&(b=c.length),b-=a.length;var d=c.indexOf(a,b);return-1!==d&&d===b});var ngCubes=angular.module("ngCubes",["ngCubes.templates"]),numberFormat=d3.format("0,000");ngCubes.filter("numeric",function(){return function(a){var b=parseFloat(a);return isNaN(b)?"-":numberFormat(Math.round(b))}}),ngCubes.factory("cubesApi",["$http","$q",function(a,b){var c={},d=function(a,b,c){var d=a.slice(),d=d.endsWith("/")?d.slice(0,d.length-1):d,d=d+"/cube/"+b+"/"+c;return d},e=function(b,e){var f=d(b,e,"model");return angular.isDefined(c[f])||(c[f]=a.get(f)),c[f]},f=function(){c={}};return{getUrl:d,getModel:e,flush:f}}]),ngCubes.directive("cubes",["$http","$rootScope","$location","cubesApi",function(a,b,c,d){return{restrict:"E",transclude:!0,scope:{slicer:"@",cube:"@",state:"="},templateUrl:"angular-cubes-templates/cubes.html",controller:["$scope",function(a){var e=this,f=angular.extend({},a.state||{},c.search());e.dataUpdate=makeSignal(),e.modelUpdate=makeSignal(),e.queryModel={},e.init=function(c){e.queryModel=c,d.getModel(a.slicer,a.cube).then(function(a){b.$broadcast(e.modelUpdate,a.data,f)})},e.getState=function(){return f},e.setState=function(a){c.search(a)},e.getApiUrl=function(b){return d.getUrl(a.slicer,a.cube,b)},e.getQuery=function(){var a={drilldown:[],aggregates:[],cut:f.cut||[],page:f.page||0,pagesize:f.pagesize||20,order:[]};return a},e.queryParams=function(a){for(var b in a){if(angular.isArray(a[b])){var c="order"==b?",":"|";a[b]=a[b].join(c)}a[b]=a[b]+"",a[b].length||delete a[b]}return{params:a}}}]}}]);var VAL_KEY="@@@@",POS_KEY="!@!@";ngCubes.directive("cubesCrosstab",["$rootScope","$http",function(a,b){return{restrict:"EA",require:"^cubes",scope:{drilldown:"="},templateUrl:"angular-cubes-templates/crosstab.html",link:function(c,d,e,f){c.columns=[],c.rows=[],c.table=[];var g=function(a,c){c.rows=asArray(c.rows),c.columns=asArray(c.columns);var d=f.getQuery();d.aggregates=d.aggregates.concat(c.aggregates),d.drilldown=d.drilldown.concat(c.rows),d.drilldown=d.drilldown.concat(c.columns),d.pagesize=1e4*d.pagesize,d.order=asArray(d.order);var e=c.rows.concat(c.columns);for(var g in e){var i=e[g];-1==d.order.indexOf(i)&&d.order.push(i)}var j=b.get(f.getApiUrl("aggregate"),f.queryParams(d));j.then(function(b){h(b.data,d,a,c)})},h=function(a,b,d,e){if(d){e.rows=asArray(e.rows),e.columns=asArray(e.columns);var f=d.aggregates.filter(function(b){return-1!=a.aggregates.indexOf(b.ref)}),g={},h=[],i=[],j=[],k=[],l=[];for(var m in a.cells){var n=function(a){return o[a]},o=a.cells[m],p=e.rows.map(n),q=p.join(VAL_KEY),r=e.columns.map(n);for(var s in f){var t=f[s],u=t.label||t.name,v=r.concat([u]);column_set=v.join(VAL_KEY),-1==k.indexOf(q)&&(k.push(q),p.key=q,i.push(p)),-1==l.indexOf(column_set)&&(l.push(column_set),j.push(v));var w=[q,column_set].join(POS_KEY);g[w]=o[t.name]}}for(var m in k){var x=k[m],y=[];for(var z in l){var A=l[z],w=[x,A].join(POS_KEY);y.push(g[w]||a.aggregates.map(function(a){return void 0}))}h.push(y)}c.rows=i,c.columns=j,c.table=h}};a.$on(f.modelUpdate,function(a,b,c){g(b,c)}),f.init({rows:{label:"Rows",multiple:!0},columns:{label:"Columns",multiple:!0}})}}}]),ngCubes.directive("cubesFacts",["$rootScope","$http",function(a,b){return{restrict:"EA",require:"^cubes",scope:{drilldown:"="},templateUrl:"angular-cubes-templates/facts.html",link:function(c,d,e,f){var g={};c.page=0,c.data=[],c.columns=[];var h=function(a,c){var d=f.getQuery(),e=b.get(f.getApiUrl("facts"),f.queryParams(d));e.then(function(a){i(a.data,d,c)})},i=function(a,b,d){if(!a.length)return c.columns=[],void(c.data=[]);var e=a[0],f=[];for(var h in e)f.push(h);f=f.sort();var i=[],j=null,k=0;for(var l in f){var m=g[f[l]],n=m.dimension?m.dimension:m;n.name==j?(i[k].span+=1,m.span=0):(m.span=1,m.label=m.label||m.name,m.header=n.label||n.name,m.hide=m.header==m.label,j=n.name,k=i.length),i.push(m)}c.columns=i,c.data=a};a.$on(f.modelUpdate,function(a,b,c){for(var d in b.measures){var e=b.measures[d];e.numeric=!0,g[e.ref]=e}for(var f in b.dimensions){var i=b.dimensions[f];for(var j in i.levels){var k=i.levels[j];for(var l in k.attributes){var m=k.attributes[l];m.dimension=i,g[m.ref]=m}}}h(b,c)}),f.init({columns:{label:"Columns",multiple:!0}})}}}]),ngCubes.directive("cubesPanel",["$rootScope",function(a){return{restrict:"EA",require:"^cubes",scope:{},templateUrl:"angular-cubes-templates/panel.html",link:function(b,c,d,e){b.model=null,b.state={};var f={},g=[],h=function(){e.setState(b.state)};b.getSelectedAggregates=function(){var a=[],c=b.model?b.model.aggregates||[]:[];for(var d in c)-1!=b.state.aggregates.indexOf(c[d].name)&&a.push(c[d]);return a},b.getAvailableAggregates=function(){var a=[],c=b.model?b.model.aggregates||[]:[];for(var d in c)-1==b.state.aggregates.indexOf(c[d].name)&&a.push(c[d]);return a},b.addAggregate=function(a){b.state.aggregates.push(a.name),h()},b.removeAggregate=function(a){var c=b.state.aggregates.indexOf(a.name);-1!=c&&(b.state.aggregates.splice(c,1),h())},b.getAvailableAttributes=function(){var a={};for(var b in f)-1==g.indexOf(b)&&(a[b]=f[b]);return a},b.getSelectedAttributes=function(a){var c={};for(var d in f)-1!=b.state[a].indexOf(d)&&(c[d]=f[d]);return c},b.hasAvailableAttributes=function(){for(var a in b.getAvailableAttributes())return!0;return!1},b.addAttribute=function(a,c){b.state[a].push(c),h()},b.removeAttribute=function(a,c){var d=b.state[a].indexOf(c);-1!=d&&(b.state[a].splice(d,1),h())},a.$on(e.modelUpdate,function(a,c,d){b.model=c,b.queryModel=e.queryModel,f={};for(var h in c.dimensions){var i=c.dimensions[h];for(var j in i.levels){var k=i.levels[j];for(var l in k.attributes){var m=k.attributes[l];m.dimension=i,f[m.ref]=m}}}if(d.aggregates=asArray(d.aggregates),b.model&&!d.aggregates.length)for(var n in b.model.aggregates)d.aggregates.push(b.model.aggregates[n].name);g=[];for(var o in b.queryModel){d[o]=asArray(d[o]);for(var p in d[o])g.push(d[o][p])}b.state=d})}}}]),ngCubes.directive("cubesWorkspace",["$location",function(a){return{restrict:"EA",scope:{slicer:"@",cube:"@"},templateUrl:"angular-cubes-templates/workspace.html",link:function(b,c,d){b.state={},b.view=a.search().view||"facts",b.setView=function(b){var c=a.search();c.view=b,a.search(c)}}}}]),angular.module("ngCubes.templates",["angular-cubes-templates/crosstab.html","angular-cubes-templates/cubes.html","angular-cubes-templates/facts.html","angular-cubes-templates/panel.html","angular-cubes-templates/workspace.html"]),angular.module("angular-cubes-templates/crosstab.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/crosstab.html",'<div class="table-cubes" ng-show="rows.length">\n  <table class="table table-bordered table-condensed">\n    <thead>\n      <tr ng-repeat="x in columns[0]">\n        <th ng-repeat="r in rows[0]"></th>\n        <th ng-repeat="c in columns">\n          {{c[$parent.$index]}}\n        </th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr ng-repeat="row in rows">\n        <th ng-repeat="r in row">\n          {{r}}\n        </th>\n        <td ng-repeat="val in table[$index] track by $index" class="numeric">\n          {{val | numeric}}\n        </td>\n      </tr>\n    </tbody>\n  </table>\n</div>\n\n<div class="alert alert-info" ng-hide="rows.length">\n  <strong>You have not selected any data.</strong> Please choose a set of rows \n  and columns to generate a cross-table.\n</div>\n')}]),angular.module("angular-cubes-templates/cubes.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/cubes.html",'<div class="cubes-frame" ng-transclude>\n</div>\n')}]),angular.module("angular-cubes-templates/facts.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/facts.html",'<div class="table-cubes" ng-show="data">\n  <table class="table table-bordered table-condensed">\n    <thead>\n      <tr>\n        <th ng-repeat="c in columns" ng-if="c.span" colspan="{{c.span}}">\n          {{ c.header }}\n        </th>\n      </tr>\n      <tr>\n        <th ng-repeat="c in columns">\n          <span ng-hide="c.hide">{{ c.label }}</span>\n        </th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr ng-repeat="row in data">\n        <td ng-repeat="c in columns" ng-class="{\'numeric\': c.numeric}">\n          <span ng-if="c.numeric">\n            {{ row[c.ref] | numeric }}\n          </span>\n          <span ng-if="!c.numeric">\n            {{ row[c.ref] }}\n          </span>\n        </td>\n      </tr>\n    </tbody>\n  </table>\n</div>\n')}]),angular.module("angular-cubes-templates/panel.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/panel.html",'<div class="panel panel-default" ng-repeat="(axis, spec) in queryModel">\n  <div class="panel-heading">\n    <strong>{{spec.label}}</strong>\n\n    <div class="btn-group" dropdown ng-show="hasAvailableAttributes()">\n      &mdash;\n      <a dropdown-toggle>Add {{spec.label.toLowerCase()}}</a>\n      <ul class="dropdown-menu" role="menu">\n        <li ng-repeat="(ref, a) in getAvailableAttributes()">\n          <a ng-click="addAttribute(axis, ref)">\n            <strong>{{a.dimension.label}}</strong> {{a.label}}\n          </a>\n        </li>\n      </ul>\n    </div>\n  </div>\n  <table class="table">\n    <tr ng-repeat="(ref, a) in getSelectedAttributes(axis)">\n      <td colspan="2">\n        <span class="pull-right">\n          <a ng-click="removeAttribute(axis, ref)">\n            <i class="fa fa-times"></i>\n          </a>\n        </span>\n        <strong>{{a.dimension.label}}</strong> {{a.label}}\n      </td>\n    </tr>\n  </table>\n</div>\n\n\n\n<div class="panel panel-default" ng-if="model">\n  <div class="panel-heading">\n    <strong>Values</strong>\n\n    <div class="btn-group" dropdown ng-show="getAvailableAggregates().length">\n      &mdash;\n      <a dropdown-toggle>Add value</a>\n      <ul class="dropdown-menu" role="menu">\n        <li ng-repeat="a in getAvailableAggregates()">\n          <a ng-click="addAggregate(a)">{{a.label}}</a>\n        </li>\n      </ul>\n    </div>\n  </div>\n  <table class="table">\n    <tr ng-repeat="a in getSelectedAggregates()">\n      <td colspan="2">\n        <span class="pull-right">\n          <a ng-click="removeAggregate(a)">\n            <i class="fa fa-times"></i>\n          </a>\n        </span>\n\n        {{a.label}}\n\n      </td>\n    </tr>\n  </table>\n</div>\n')}]),angular.module("angular-cubes-templates/workspace.html",[]).run(["$templateCache",function(a){a.put("angular-cubes-templates/workspace.html",'<cubes slicer="{{slicer}}" cube="{{cube}}" state="state">\n  <div class="row">\n    <div class="col-md-9">\n      <div ng-if="view == \'crosstab\'">\n        <cubes-crosstab></cubes-crosstab>\n      </div>\n      <div ng-if="view == \'facts\'">\n        <cubes-facts></cubes-facts>\n      </div>\n    </div>\n    <div class="col-md-3">\n      <div class="btn-group spaced" role="group">\n        <a class="btn btn-default"\n          ng-class="{\'active\': view == \'facts\'}"\n          ng-click="setView(\'facts\')">\n          <i class="fa fa-table"></i> Line items\n        </a>\n        <a class="btn btn-default"\n          ng-class="{\'active\': view == \'crosstab\'}"\n          ng-click="setView(\'crosstab\')">\n          <i class="fa fa-cubes"></i> Crosstab\n        </a>\n        <!--a type="button" class="btn btn-default disabled">\n          <i class="fa fa-bar-chart"></i>\n        </a-->\n      </div>\n      <cubes-panel></cubes-panel>\n    </div>\n  </div>\n</cubes>\n')}]);