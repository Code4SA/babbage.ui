!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Babbage=t():e.Babbage=t()}(this,function(){return function(e){function t(a){if(r[a])return r[a].exports;var n=r[a]={exports:{},id:a,loaded:!1};return e[a].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";r(2),r(1),r(3),r(4),r(5),r(6),r(7),r(8),r(9),r(10),r(11),r(12),e.exports="ngBabbage"},function(e,t){"use strict";ngBabbage.factory("babbageApi",["$http","$q","slugifyFilter",function(e,t,r){var a={},n=function(e,t,r){var a=e.slice(),a=a.endsWith("/")?a.slice(0,a.length-1):a,a=a+"/cubes/"+t+"/"+r;return a},i=function(t){return angular.isDefined(a[t])||(a[t]=e.get(t)),a[t]},o=function(e,t){return i(n(e,t,"model")).then(function(e){var t=e.data.model;t.refs={},t.refKeys={},t.refLabels={};for(var a in t.measures){var n=t.measures[a];n.numeric=!0,n.hideLabel=!0,t.refs[n.ref]=n}for(var a in t.aggregates){var i=t.aggregates[a];i.numeric=!0,i.hideLabel=!0,t.refs[i.ref]=i}for(var o in t.dimensions){var s=t.dimensions[o];for(var l in s.attributes){var u=s.attributes[l],c=-1!=u.ref.indexOf(".");u.dimension=s,u.hideLabel=r(u.label)==r(s.label),t.refs[u.ref]=u,t.refKeys[u.ref]=c?s.name+"."+s.key_attribute:u.ref,t.refLabels[u.ref]=c?s.name+"."+s.label_attribute:u.ref}}return t})},s=function(e,t,r){return i(n(e,t,"members/"+r))},l=function(){a={}};return{getUrl:n,getModel:o,getDimensionMembers:s,flush:l}}])},function(e,t){"use strict";var r=angular.module("ngBabbage",["ngBabbage.templates"]),a=a||{};if(a.numberFormat=d3.format("0,000"),a.categoryColors=["#CF3D1E","#F15623","#F68B1F","#FFC60B","#DFCE21","#BCD631","#95C93D","#48B85C","#00833D","#00B48D","#60C4B1","#27C4F4","#478DCB","#3E67B1","#4251A3","#59449B","#6E3F7C","#6A246D","#8A4873","#EB0080","#EF58A0","#C05A89"],a.colorScale=d3.scale.ordinal().range(a.categoryColors),!a.embedSite){var n=window.location.href.split("#")[0],i=n.lastIndexOf("/"),i=-1==i?n.length:i;a.embedSite=n.slice(0,i)}a.embedLink=a.embedSite+"/embed.html",r.filter("numeric",function(){return function(e){var t=parseFloat(e);return isNaN(t)?"-":a.numberFormat(Math.round(t))}})},function(e,t){"use strict";ngBabbage.directive("babbage",["$http","$rootScope","$location","babbageApi",function(e,t,r,a){return{restrict:"E",transclude:!0,scope:{endpoint:"@",cube:"@",state:"=",update:"&"},templateUrl:"babbage-templates/babbage.html",controller:["$scope",function(e){var t=this;t.queryModel=null,t.init=function(e){t.queryModel=e,t.update()},t.update=function(){t.queryModel&&a.getModel(e.endpoint,e.cube).then(function(t){e.$broadcast("babbageUpdate",t,e.state)})},t.subscribe=function(t){return e.$on("babbageUpdate",t)},t.getState=function(){return e.state},t.isEmbedded=function(){return"true"==e.state.embed},t.setState=function(r){e.state=r,t.update(),e.update(r)},t.getApiUrl=function(t){return a.getUrl(e.endpoint,e.cube,t)},t.getDimensionMembers=function(t){return a.getDimensionMembers(e.endpoint,e.cube,t)},t.size=function(e,r){return t.isEmbedded()?{width:document.documentElement.clientWidth,height:document.documentElement.clientHeight}:{width:e.clientWidth,height:r(e.clientWidth,e.clientHeight)}},t.getSorts=function(){var t=[],r=e.state.order||"",r=asArray(r.split(","));for(var a in r){var n=r[a].split(":"),i={};i.ref=n[0],i.direction=n[1]||null,i.ref.length&&t.push(i)}return t},t.getSort=function(e){var r=t.getSorts();for(var a in r)if(r[a].ref==e)return r[a];return{ref:e}},t.pushSort=function(r,a){var n=t.getSorts().filter(function(e){return e.ref!=r});n.unshift({ref:r,direction:a}),e.state.order=t.mergeSorts(n),t.setState(e.state)},t.removeSorts=function(e){var r=t.getSorts().filter(function(t){return t.ref!=e});return t.mergeSorts(r)},t.mergeSorts=function(e){var t=[];e=asArray(e);for(var r in e){var a=e[r];angular.isObject(a)&&a.ref.length&&(a.direction=a.direction||"asc",a=a.ref+":"+a.direction,t.push(a))}return t.join(",")},t.getQuery=function(){var r={drilldown:[],aggregates:[],cut:e.state.cut||[],page:e.state.page||0,pagesize:e.state.pagesize||30,order:t.getSorts()};return r},t.queryParams=function(e){e.order=t.mergeSorts(e.order);for(var r in e)angular.isArray(e[r])&&(-1!=["order","fields"].indexOf(r)?e[r]=e[r].join(","):e[r]=e[r].join("|")),e[r]=e[r]+"",e[r].length||delete e[r];return{params:e}}}]}}])},function(e,t){"use strict";ngBabbage.directive("babbageChart",["$rootScope","$http",function(e,t){return{restrict:"EA",require:"^babbage",scope:{chartType:"@"},templateUrl:"babbage-templates/chart.html",link:function(e,r,a,n){e.queryLoaded=!1,e.cutoffWarning=!1,e.cutoff=0;var i=function(e){var t={};for(var r in e.refs){var a=e.refs[r];t[r]=a.label||a.name||r}return t},o=function(e,t,r,a){var n=[[t]],i={category:0};for(var o in e){var s=e[o],l=r?s[r]:a;i[l]||(i[l]=n.push([l])-1),n[0].indexOf(s[t])<1&&n[0].push(s[t]);var u=n[0].indexOf(s[t]);n[i[l]][u]=s[a]}for(var c=Math.max.apply(null,n.map(function(e){return e.length})),o=1;c>o;o++)for(var d in n)n[d][o]=n[d][o]||0;return n},s=function(e,r){var a=asArray(r.category)[0],i=asArray(r.grouping)[0],o=asArray(r.value)[0];if(o&&a){var s=n.getQuery();s.aggregates=[o],s.drilldown=[a],i&&s.drilldown.push(i);var u=[];for(var c in s.order){var d=s.order[c];-1!=[o,a].indexOf(d.ref)&&u.push(d)}u.length||(u=[{ref:o,direction:"desc"}]),i&&u[0]&&u[0].ref!=i&&u.unshift({ref:i,direction:"asc"}),s.order=u,s.page=0,s.pagesize=1e4;var g=t.get(n.getApiUrl("aggregate"),n.queryParams(s));g.then(function(t){l(t.data,s,e,r,a,i,o)})}},l=function(t,a,s,l,u,c,d){var g=r.querySelectorAll(".chart-babbage")[0],f=n.size(g,function(e){return.6*e}),b=ngBabbageGlobals.colorScale.copy(),p=o(t.cells,u,c,d),m=i(s),v=[],h={},y=e.chartType;c&&"line"==y&&(y="area");for(var x in p)x>0&&(c?(key=randomKey(),m[key]=p[x][0],p[x][0]=key,v.push(key)):v.push(p[x][0]),h[p[x][0]]=y);d3.select(g).style("width",f.width+"px").style("height",f.height+"px");c3.generate({bindto:g,data:{columns:p,names:m,color:function(e,t){var r=t.id||t;return"bar"!=y||c||(r=t.index),b(r)},order:null,x:u,groups:[v],types:h},point:{show:!1},grid:{focus:{show:!1}},axis:{x:{type:"category",tick:{culling:!0,fit:!0}},y:{tick:{format:ngBabbageGlobals.numberFormat,culling:!0,fit:!0},lines:[{value:0}]}}});e.queryLoaded=!0,e.cutoffWarning=t.total_cell_count>a.pagesize,e.cutoff=a.pagesize},u=n.subscribe(function(e,t,r){s(t,r)});e.$on("$destroy",u);var c={value:{label:"Value",addLabel:"set height",types:["aggregates"],defaults:[],sortId:1,multiple:!1},grouping:{label:"Grouping (opt)",addLabel:"select",types:["attributes"],defaults:[],sortId:2,remove:!0,multiple:!1}};"line"==e.chartType&&(c.category={label:"Series",addLabel:"set series",types:["attributes"],defaults:[],sortId:0,multiple:!1}),"bar"==e.chartType&&(c.category={label:"Categories",addLabel:"set bars",types:["attributes"],defaults:[],sortId:0,multiple:!1}),n.init(c)}}}])},function(e,t){"use strict";var r="@@@@",a="!@!@";ngBabbage.directive("babbageCrosstab",["$rootScope","$http",function(e,t){return{restrict:"EA",require:"^babbage",scope:{drilldown:"="},templateUrl:"babbage-templates/crosstab.html",link:function(e,n,i,o){e.queryLoaded=!1,e.columns=[],e.rows=[],e.table=[];var s=function(e,r){r.rows=asArray(r.rows),r.columns=asArray(r.columns),r.aggregates=asArray(r.aggregates);var a=o.getQuery();a.aggregates=a.aggregates.concat(r.aggregates),a.aggregates.length||(a.aggregates=c(e)),a.drilldown=a.drilldown.concat(r.rows),a.drilldown=a.drilldown.concat(r.columns),a.page=0,a.pagesize=1e4*a.pagesize,a.order=asArray(a.order);var n=r.rows.concat(r.columns),i=n.concat(a.aggregates);for(var s in n){var u=n[s];o.getSort(u).direction||-1==a.order.indexOf(u)&&a.order.push({ref:u})}var d=[];for(var s in a.order){var g=a.order[s];-1!=i.indexOf(g.ref)&&d.push(g)}a.order=d;var f=t.get(o.getApiUrl("aggregate"),o.queryParams(a));f.then(function(t){l(t.data,a,e,r)})},l=function(t,n,i,o){o.rows=asArray(o.rows),o.columns=asArray(o.columns);var s=t.aggregates.map(function(e){return i.aggregates[e]}),l={},u=[],c=[],d=[],g=[],f=[];for(var b in t.cells){var p=function(e){return v[e]},m=function(e){return v[i.refKeys[e]]+v[e]},v=t.cells[b],h=o.rows.map(p),y=o.rows.map(m).join(r),x=o.columns.map(p),A=o.columns.map(m);for(var w in s){var S=s[w],k=S.label||S.name,$=x.concat([k]);column_set=A.concat([k]).join(r),-1==g.indexOf(y)&&(g.push(y),h.key=y,c.push(h)),-1==f.indexOf(column_set)&&(f.push(column_set),d.push($));var L=[y,column_set].join(a);l[L]=v[S.ref]}}for(var b in g){var q=g[b],B=[];for(var _ in f){var F=f[_],L=[q,F].join(a);B.push(l[L]||t.aggregates.map(function(e){}))}u.push(B)}e.rows=c,e.columns=d,e.table=u,e.queryLoaded=!0},u=o.subscribe(function(e,t,r){s(t,r)});e.$on("$destroy",u);var c=function(e){var t=[];for(var r in e.aggregates){var a=e.aggregates[r];t.push(a.ref)}return t};o.init({columns:{label:"Columns",addLabel:"add column",types:["attributes"],defaults:[],sortId:0,multiple:!0},rows:{label:"Rows",addLabel:"add row",types:["attributes"],defaults:[],sortId:1,multiple:!0},aggregates:{label:"Values",addLabel:"add value",types:["aggregates"],defaults:c,sortId:2,multiple:!0}})}}}])},function(e,t){"use strict";ngBabbage.directive("babbageFacts",["$rootScope","$http","$q",function(e,t,r){return{restrict:"EA",require:"^babbage",scope:{drilldown:"="},templateUrl:"babbage-templates/facts.html",link:function(e,r,a,n){e.page=0,e.data=[],e.columns=[],e.pagerCtx={},e.getSort=n.getSort,e.pushSort=n.pushSort;var i=function(e,r){var a=n.getQuery();a.fields=asArray(r.fields),0==a.fields.length&&(a.fields=s(e));var i=[];for(var l in a.order){var u=a.order[l];-1!=a.fields.indexOf(u.ref)&&i.push(u)}a.order=i;var c=angular.copy(a);c.drilldown=c.fields=[],c.page=0;var d=t.get(n.getApiUrl("facts"),n.queryParams(a));d.then(function(t){o(t.data,a,r,e)})},o=function(t,r,a,n){if(!t.data.length)return e.columns=[],e.data=[],void(e.pagerCtx={});var i=[],o=null,s=0;for(var l in t.fields){var u=t.fields[l],c=n.refs[u],d=c.dimension?c.dimension:c;o&&d.name==o?(i[s].span+=1,c.span=0):(c.span=1,c.label=c.label||c.name,c.header=d.label||d.name,c.hide=c.hideLabel,o=d.name,s=i.length),i.push(c)}e.columns=i,e.data=t.data,e.pagerCtx={page:r.page,pagesize:r.pagesize,total:t.total_fact_count}},s=function(e){var t=[];for(var r in e.measures){var a=e.measures[r];t.push(a.ref)}for(var r in e.dimensions){var n=e.dimensions[r];for(var i in n.attributes){var o=n.attributes[i];i==n.label_attribute&&t.push(o.ref)}}return t},l=n.subscribe(function(e,t,r){i(t,r)});e.$on("$destroy",l),n.init({fields:{label:"Columns",addLabel:"add column",types:["attributes","measures"],defaults:s,sortId:0,multiple:!0}})}}}])},function(e,t){"use strict";ngBabbage.directive("babbagePager",["$timeout","$location",function(e,t){return{restrict:"E",require:"^babbage",scope:{context:"="},templateUrl:"babbage-templates/pager.html",link:function(e,t,r,a){e.showPager=!1,e.hasPrev=!1,e.hasNext=!1,e.pages=[],e.cur=0,e.num=0,e.$watch("context",function(t){if(e.context&&!(e.context.total<=e.context.pagesize)){e.current=parseInt(e.context.page,10)||0,e.num=Math.ceil(e.context.total/e.context.pagesize);var r=[],a=e.num,n=3,i=e.current-n,o=e.current+n;0>i&&(i=0,o=Math.min(2*n+1,a)),o>a&&(o=a,i=Math.max(1,a-2*n+1));for(var s=i;o>=s;s++)r.push({page:s,current:s==e.current});e.hasPrev=e.current>0,e.hasNext=e.current<a,e.showPager=a>1,e.pages=r}}),e.setPage=function(t){if(t>=0&&t<=e.num){var r=a.getState();r.page=t,a.setState(r)}}}}}])},function(e,t){"use strict";ngBabbage.directive("babbagePanel",["$rootScope","slugifyFilter",function(e,t){return{restrict:"EA",require:"^babbage",scope:{},templateUrl:"babbage-templates/panel.html",link:function(e,r,a,n){var i=null;e.state={},e.axes=[],e.filterAttributes=[],e.filters=[],e.getSort=n.getSort,e.pushSort=n.pushSort,e.embedLink=null;var o=function(){n.setState(e.state)};e.add=function(t,r){-1==t.selected.indexOf(r)&&(t.multiple?t.selected.push(r):(t.selected.length&&(e.state.order=n.removeSorts(t.selected[0])),t.selected=[r]),e.state[t.name]=t.selected,o())},e.remove=function(t,r){var a=t.selected.indexOf(r);-1!=a&&(t.selected.splice(a,1),e.state[t.name]=t.selected,e.state.order=n.removeSorts(r),o())};var s=function(){var e=[];for(var r in i.dimensions){var a=i.dimensions[r];for(var n in a.attributes){var o=angular.copy(a.attributes[n]);o.dimension=a,o.type="attributes",t(a.label)!=t(o.label)&&(o.subLabel=""+o.label),o.sortKey="0"+a.label+o.label,o.label=a.label,e.push(o)}}for(var n in i.aggregates){var s=i.aggregates[n];s.type="aggregates",s.sortKey="1"+n,e.push(s)}for(var l in i.measures){var u=i.measures[l];u.type="measures",u.sortKey="2"+l,e.push(u)}return e},l=function(e,t){return e.label.localeCompare(t.label)},u=function(e,t){var r=[];if(!n.queryModel)return[];for(var a in n.queryModel){var o=n.queryModel[a];o.name=a,angular.isDefined(o.remove)||(o.remove=o.multiple),o.sortId=o.sortId||1,o.available=[],o.active=[],o.selected=asArray(e[a]),o.selected.length||(angular.isFunction(o.defaults)?o.selected=o.defaults(i):o.selected=asArray(o.defaults)),o.available=o.available.sort(l),o.active=o.active.sort(l);for(var s in t){var u=t[s];-1!=o.selected.indexOf(u.ref)?o.active.push(u):-1!=o.types.indexOf(u.type)&&o.available.push(u)}r.push(o)}return r.sort(function(e,t){return e.sortId-t.sortId})},c=function(e){var t=[];for(var r in e){var a=e[r];"attributes"==a.type&&"high"!=a.dimension.cardinality_class&&a.dimension.label_ref==a.ref&&t.push(a)}return t.sort(l)},d=function(t){for(var r in e.filterAttributes){var a=e.filterAttributes[r];if(a.ref==t)return a}},g=function(t){var r=asArray(t.cut);for(var a in r){var n=r[a];if(-1!=n.indexOf(":")){var i=n.split(":",1)[0],o=n.slice(i.length+1).split(";");for(var s in o)e.addFilter(d(i),o[s])}}};e.addFilter=function(t,r){n.getDimensionMembers(t.ref).then(function(a){e.filters.push({ref:t.ref,attr:t,value:r,values:a.data.data.map(function(e){return e[t.ref]})})})},e.removeFilter=function(t){var r=e.filters.indexOf(t);-1!=r&&(e.filters.splice(r,1),e.updateFilters())},e.setFilter=function(t,r,a){e.updateFilters()},e.updateFilters=function(){var t={};for(var r in e.filters){var a=e.filters[r];angular.isUndefined(t[a.ref])&&(t[a.ref]=[]),t[a.ref].push(a.value)}var n=[];for(var i in t){var s=t[i],l=s.join(";");cut=i+":"+l,n.push(cut)}e.state.cut=n,o()};var f=n.subscribe(function(t,r,a){i=r,e.state=a;var n=s();e.axes=u(a,n),e.filterAttributes=c(n),e.filters=[],g(a)});e.$on("$destroy",f)}}}])},function(e,t){"use strict";ngBabbage.directive("babbageSankey",["$rootScope","$http","$document",function(e,t,r){return{restrict:"EA",require:"^babbage",scope:{drilldown:"="},templateUrl:"babbage-templates/sankey.html",link:function(e,r,a,n){var i=15,o={top:i/2,right:1,bottom:6,left:1},s=null,l=null;e.queryLoaded=!1,e.cutoffWarning=!1,e.cutoff=0;var u=function(a,u){var d=asArray(u.source)[0],f=asArray(u.target)[0];aggregate=asArray(u.aggregate)[0],aggregate=aggregate?[aggregate]:g(a);var b=n.getQuery();if(b.aggregates=aggregate,d&&f){b.drilldown=[d,f],b.order=[{ref:aggregate,direction:"desc"},{ref:d,direction:"asc"},{ref:f,direction:"asc"}],b.page=0,b.pagesize=2e3,e.queryLoaded=!0,e.cutoffWarning=!1;var p=t.get(n.getApiUrl("aggregate"),n.queryParams(b)),m=r.querySelectorAll(".sankey-babbage")[0],v=n.size(m,function(e){return.6*e});i=Math.max(400,v.height)/20,s||(s=d3.select(m).append("svg"),l=s.append("g").attr("transform","translate("+o.left+","+o.top+")")),p.then(function(e){c(v,e.data,b,a,u)})}},c=function(t,r,a,n,u){var c=asArray(u.source)[0],d=asArray(u.target)[0];aggregateRef=asArray(u.aggregate)[0],aggregateRef=aggregateRef?[aggregateRef]:g(n),t.height=r.cells.length*i,s.attr("height",t.height+o.top+o.bottom),s.attr("width",t.width);var f={nodes:[],links:[]},b={},p=ngBabbageGlobals.colorScale.copy(),m=d3.scale.ordinal().range(["#ddd","#ccc","#eee","#bbb"]);r.cells.forEach(function(e){var t=e[c],r=e[d],a={value:e[aggregateRef],number:ngBabbageGlobals.numberFormat(e[aggregateRef])};if(0!=a.value&&t&&r){if(t="source-"+c+t,r="target-"+d+r,!b[t]){var i=e[n.refLabels[c]];f.nodes.push({name:i,color:p(t)}),b[t]={idx:f.nodes.length-1}}if(a.source=b[t].idx,!b[r]){var i=e[n.refLabels[d]];f.nodes.push({name:i,color:m(r)}),b[r]={idx:f.nodes.length-1}}a.target=b[r].idx,f.links.push(a)}});var v=d3.sankey().nodeWidth(i).nodePadding(.6*i).size([t.width,t.height]),h=v.link();v.nodes(f.nodes).links(f.links).layout(32),l.selectAll("g").remove();var y=l.append("g").selectAll(".link").data(f.links).enter().append("path").attr("class","link").attr("d",h).style("stroke-width",function(e){return Math.max(1,e.dy)}).style("stroke",function(e){return e.source.color}).sort(function(e,t){return t.dy-e.dy});y.append("title").text(function(e){return e.source.name+" → "+e.target.name+"\n"+e.number});var x=l.append("g").selectAll(".node").data(f.nodes).enter().append("g").attr("class","node").attr("transform",function(e){return"translate("+e.x+","+e.y+")"});x.append("rect").attr("height",function(e){return e.dy}).attr("width",v.nodeWidth()).style("fill",function(e){return e.color}).style("stroke",function(e){return e.color}).append("title").text(function(e){return e.name}),x.append("text").attr("x",-6).attr("y",function(e){return e.dy/2}).attr("dy",".35em").attr("text-anchor","end").attr("transform",null).text(function(e){return e.name}).filter(function(e){return e.x<t.width/2}).attr("x",6+v.nodeWidth()).attr("text-anchor","start"),e.cutoffWarning=r.total_cell_count>a.pagesize,e.cutoff=a.pagesize},d=n.subscribe(function(e,t,r){u(t,r)});e.$on("$destroy",d);var g=function(e){for(var t in e.aggregates){var r=e.aggregates[t];if(r.measure)return[r.ref]}return[]};n.init({source:{label:"Source",addLabel:"set left side",types:["attributes"],defaults:[],sortId:0,multiple:!1},target:{label:"Target",addLabel:"set right side",types:["attributes"],defaults:[],sortId:1,multiple:!1},aggregate:{label:"Width",addLabel:"set width",types:["aggregates"],defaults:g,sortId:2,multiple:!1}})}}}])},function(e,t){"use strict";ngBabbage.directive("babbageTreemap",["$rootScope","$http","$document",function(e,t,r){return{restrict:"EA",require:"^babbage",scope:{drilldown:"="},templateUrl:"babbage-templates/treemap.html",link:function(e,r,a,n){function i(){this.style("left",function(e){return e.x+"px"}).style("top",function(e){return e.y+"px"}).style("width",function(e){return Math.max(0,e.dx-1)+"px"}).style("height",function(e){return Math.max(0,e.dy-1)+"px"})}var o=null,s=null;e.queryLoaded=!1,e.cutoffWarning=!1;var l=function(a,i){var l=asArray(i.tile)[0],c=asArray(i.area)[0],c=c?[c]:d(a),g=n.getQuery();if(g.aggregates=c,l){g.drilldown=[l];var f=[];for(var b in g.order){var p=g.order[b];-1!=[l,c].indexOf(p.ref)&&f.push(p)}f.length||(f=[{ref:c,direction:"desc"}]),g.order=f,g.page=0,g.pagesize=50,e.cutoffWarning=!1,e.queryLoaded=!0;var m=t.get(n.getApiUrl("aggregate"),n.queryParams(g)),v=r.querySelectorAll(".treemap-babbage")[0],h=n.size(v,function(e){return.6*e});o=d3.layout.treemap().size([h.width,h.height]).sticky(!0).sort(function(e,t){return e[c]-t[c]}).value(function(e){return e[c]}),d3.select(v).select("div").remove(),s=d3.select(v).append("div").style("position","relative").style("width",h.width+"px").style("height",h.height+"px"),m.then(function(e){u(e.data,g,a,i)})}},u=function(t,r,a,n){var l=asArray(n.tile)[0],u=asArray(n.area)[0],u=u?[u]:d(a),c={children:[]};for(var g in t.cells){var f=t.cells[g];f._area_fmt=ngBabbageGlobals.numberFormat(Math.round(f[u])),f._name=f[l],f._color=ngBabbageGlobals.colorScale(g),f._percentage=f[u]/Math.max(t.summary[u],1),c.children.push(f)}s.datum(c).selectAll(".node").data(o.nodes).enter().append("a").attr("href",function(e){return e.href}).attr("class","node").call(i).style("background","#fff").html(function(e){return e._percentage<.02?"":e.children?null:'<span class="amount">'+e._area_fmt+"</span>"+e._name}).on("mouseover",function(e){d3.select(this).transition().duration(200).style({background:d3.rgb(e._color).darker()})}).on("mouseout",function(e){d3.select(this).transition().duration(500).style({background:e._color})}).transition().duration(500).delay(function(e,t){return Math.min(30*t,1500)}).style("background",function(e){return e._color});e.cutoffWarning=t.total_cell_count>r.pagesize,e.cutoff=r.pagesize},c=n.subscribe(function(e,t,r){l(t,r)});e.$on("$destroy",c);var d=function(e){for(var t in e.aggregates){var r=e.aggregates[t];if(r.measure)return[r.ref]}return[]};n.init({tile:{label:"Tiles",addLabel:"set breakdown",types:["attributes"],defaults:[],sortId:0,multiple:!1},area:{label:"Area",addLabel:"set area",types:["aggregates"],defaults:d,sortId:1,multiple:!1}})}}}])},function(e,t){"use strict";String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var r=this.toString();(void 0===t||t>r.length)&&(t=r.length),t-=e.length;var a=r.indexOf(e,t);return-1!==a&&a===t})},function(e,t){"use strict";ngBabbage.directive("babbageWorkspace",["$location",function(e){return{restrict:"EA",scope:{endpoint:"@",cube:"@"},templateUrl:"babbage-templates/workspace.html",link:function(t,r,a){t.state=null,t.embedLink=null,t.setView=function(e){t.view=e,t.state.view=e,t.update(t.state)},t.update=function(r){t.state=r,t.view=t.state.view||"facts",e.search(r),n()};var n=function(){var r=[],a=angular.extend({},e.search(),{view:t.view,endpoint:t.endpoint,cube:t.cube,embed:!0});for(var n in a){var i=asArray(a[n]);for(var o in i){var s=encodeURIComponent(i[o]);r.push(n+"="+s)}}t.embedLink=ngBabbageGlobals.embedLink+"#/?"+r.join("&")};t.update(e.search())}}}])}])});
//# sourceMappingURL=babbage.min.js.map